---
title: "HamiltonHotSpots"
author: "Pete Way"
date: "3/21/2019"
output: pdf_document
---

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(ggmap)
utc=read.csv("../Excel & CSV Sheets/Full Data.csv", header=T)
# min(utc$Latitude)
# max(utc$Latitude)
# min(utc$Longitude)
# max(utc$Longitude)
#
a=which(utc$Accident==1)
df=utc[a,]

# #
locations=data.frame(df$Route, df$Longitude, df$Latitude)
u=unique(locations)
# #
sums=rep(0, dim(u)[1])#'sums' will be the # of accidents at each unique loc.
for (i in 1:dim(u)[1]){
w=which(df$Route==u[i,1] & df$Longitude==u[i,2] &
	df$Latitude==u[i,3])
sums[i]<-length(df$Accident[w])
}

# #
df4=data.frame(u, sums)#uniques locations and the number of accidents there
# hs = which(df4$sums>25)
# df4=df4[hs,]

# #
rank=rep(NA, dim(df4)[1])
rank[which(sums<=25)] <-'yellow'
rank[which(sums<=75)] <-'orange'
rank[which(sums<=125)] <-'red'
rank[which(sums>=150)] <-'black'


locs=data.frame(u[,2:3])
# 
# y=which(rank=='yellow')
# r=which(rank=='red')
# b=which(rank=='black')
# o = which(rank=='orange')

# df4[0:10,]

df4$rank <- rank


df5 = df4[!is.na(df4$rank),]
df5[0:10,]


df5$rank = with(df5, reorder(df5$rank, df5$sum))
df5[0:10,]

lats<-c(34.99, 35.15)
lons<-c(-85.4,-85.05)


# png("../Graphs & Images/R Maps/HamiltonHotSpotsMapstamen.png", width=12,height=6,units='in', res=300)
par(mar = rep(0, 4))
bb<-make_bbox(lon=lons,lat=lats, f=0.05)
calc_zoom(bb)
# bb<-make_bbox(lon=lons,lat=lats,f=0.05)
cda<-get_map(bb,zoom=11,maptype="watercolor", source='stamen')
ggmap(cda, legend = "bottom") +
  xlim(lons)+ylim(lats)+theme_minimal(base_size = 22)+
  labs(x="",y="", title="Accidents in Chattanooga") +
  geom_point(aes(x=df.Longitude, y=df.Latitude, color=df5$rank), data=df5, alpha = .75)  + guides( guide = "none" ) + scale_color_manual(values = c("orange","red","black"),  labels = c("25 - 50","50 - 75"," > 75"), name = "Accidents")


               # Inside the ggmap call, put this : , legend="right"

# dev.off()


```

```{r}
library(ggmap)

accidents =read.csv("../Excel & CSV Sheets/2019 Data/DailyReports/911_Reports_for_2019-03-22.csv", header=T)
colnames(accidents)
# forecast18 =read.csv("../Excel & CSV Sheets/ Forecast Files/Forecast-for3-22-2019_2019-03-21_18 other.csv", header=T)
# nrow(forecast18)
# forecast00 =read.csv("../Excel & CSV Sheets/ Forecast Files/Forecast-for3-22-2019_2019-03-22_0.csv", header=T)

forecast06 =read.csv("../Excel & CSV Sheets/ Forecast Files/Forecast-for3-22-2019_2019-03-22_6.csv", header=T)
# 
# forecast12 =read.csv("../Excel & CSV Sheets/ Forecast Files/Forecast-for3-22-2019_2019-03-22_12.csv", header=T)
#
# a=which(forecast18$Prediction==1)
# length(a)
# forecast18=forecast18[a,]
# nrow(forecast18)
#
# a=which(forecast00$Prediction==1)
# forecast00=forecast00[a,]
# a=which(forecast06$Prediction==1)
# forecast06=forecast06[a,]
a=which(forecast06$Prediction==1)
forecast06=forecast06[a,]

# colnames(accidents)
# colnames(forecast1)
# colnames(forecast2)
sixPM = which(forecast06$Probability>=0.50)
forecast06=forecast06[sixPM,]
cat("Number of entries above 50 percent sure, 6AM",nrow(forecast06))

midnight = which(forecast06$Probability>=0.50)
forecast06_50=forecast06[midnight,]
cat("\nNumber of entries above 50 percent sure",nrow(forecast06_50))
midnight = which(forecast06$Probability>=0.70)
forecast06_70=forecast06[midnight,]
cat("\nNumber of entries above 70 percent sure",nrow(forecast06_70))
midnight = which(forecast06$Probability>=0.90)
forecast06_90=forecast06[midnight,]
cat("\nNumber of entries above 90 percent sure",nrow(forecast06_90))

# sixAM = which(forecast06$Probability>=0.50)
# forecast06=forecast06[sixAM,]
# cat("\nNumber of entries above 50 percent sure, 6AM",nrow(forecast06))
# noon = which(forecast12$Probability>=0.50)
# forecast12=forecast12[noon,]
# cat("\nNumber of entries above 50 percent sure, noon",nrow(forecast12))

# add_points <- function(df, colored, sized, alphed) {
#   geom_point(aes(x=df$Longitude, y=df$Latitude),data=df, color= colored, alpha=alphed, size=sized)
# }

lats<-c(34.99, 35.45)
lons<-c(-85.4,-85.05)
png("../Graphs & Images/R Maps/50thresh_6am_March22.png", width=12,height=12,units='in', res=900)
par(mar = rep(0, 4))
bb<-make_bbox(lon=lons,lat=lats, f=0.05)
# calc_zoom(bb)
cda<-get_map(bb,zoom=13,maptype="roadmap", source='google')
ggmap(cda) +
  xlim(lons)+ylim(lats)+theme_minimal(base_size = 18) +
  labs(x="Longitude",y="Latitude", title="Accidents in Chattanooga on March 22 - 6AM .5 Threshold") +
  geom_point(aes(x=forecast06_50$Longitude, y=forecast06_50$Latitude), data=forecast06_50, color= 'purple', alpha=.3, size=1.5) +  geom_point(aes(x=accidents$Longitude, y=accidents$Latitude), data=accidents, color= 'red', alpha=.7, size=2)
dev.off()


png("../Graphs & Images/R Maps/70thresh_6am_March22.png", width=12,height=12,units='in', res=900)
par(mar = rep(0, 4))
# calc_zoom(bb)
cda<-get_map(bb,zoom=13,maptype="roadmap", source='google')
ggmap(cda) +
  xlim(lons)+ylim(lats)+theme_minimal(base_size = 18) +
  labs(x="Longitude",y="Latitude", title="Accidents in Chattanooga on March 22 - 6AM .7 Threshold") +
  geom_point(aes(x=forecast06_70$Longitude, y=forecast06_70$Latitude), data=forecast06_70, color= 'purple', alpha=.3, size=1.5) +  geom_point(aes(x=accidents$Longitude, y=accidents$Latitude), data=accidents, color= 'red', alpha=.7, size=2)
dev.off()

png("../Graphs & Images/R Maps/90thresh_6am_March22.png", width=12,height=12,units='in', res=900)
par(mar = rep(0, 4))
bb<-make_bbox(lon=lons,lat=lats, f=0.05)
# calc_zoom(bb)
cda<-get_map(bb,zoom=13,maptype="roadmap", source='google')
ggmap(cda) +
  xlim(lons)+ylim(lats)+theme_minimal(base_size = 18) +
  labs(x="Longitude",y="Latitude", title="Accidents in Chattanooga on March 22 - 6AM .9 Threshold") +
  geom_point(aes(x=forecast06_90$Longitude, y=forecast06_90$Latitude), data=forecast06_90, color= 'purple', alpha=.3, size=1.5) +  geom_point(aes(x=accidents$Longitude, y=accidents$Latitude), data=accidents, color= 'red', alpha=.7, size=2)
dev.off()

```

```{r}
library(ggmap)
accidents =read.csv("/Users/pete/Downloads/Accident Report.csv", header=T)
# head(accidents)
accidents = accidents[,c('Latitude','Longitude')]
accidents['Probability'] = 1
# head(accidents)

forecastMMR =read.csv("../Excel & CSV Sheets/Forecast Files/Forecast-for4-3-2019_2019-04-02_18_minmax_withpred.csv", header=T)

timesorted = read.csv("../Excel & CSV Sheets/Forecast Files/Forecast-for4-3-2019_2019-04-03_6_timesorted.csv", header=T)

forecaststand =read.csv("../Excel & CSV Sheets/Forecast Files/Forecast-for4-3-2019_2019-04-02_18_noMM.csv", header=T)

forecastMMR$Latitude = forecaststand$Latitude
forecastMMR$Longitude = forecaststand$Longitude

a=which(forecastMMR$Prediction==1)
length(a)
forecastMMR=forecastMMR[a,c('Latitude','Longitude', 'Probability')]

a=which(timesorted$Prediction==1)
length(a)
timesorted=timesorted[a,c('Latitude','Longitude', 'Probability')]

b=which(forecaststand$Prediction==1)
forecaststand=forecaststand[b,c('Latitude','Longitude', 'Probability')]
length(b)

# library(reshape)
# zz <- melt(list(MMR=forecastMMR,stand=forecaststand,accident=accidents), id.vars=c("Latitude", "Longitude", "Probability"))
# head(zz)

zz <- melt(list(TimeSorted=timesorted, accident=accidents), id.vars=c("Latitude", "Longitude", "Probability"))
head(zz)

thresh = which(zz$Probability>=0.90)
zz=zz[thresh,]


png("../Graphs & Images/R Maps/April03/April03_6PM_.90thresh.png", width=6,height=6,units='in', res=800)
lats<-c(34.99, 35.45)
lons<-c(-85.4,-85.05)
par(mar = rep(0, 4))
bb<-make_bbox(lon=lons,lat=lats, f=0.05)
calc_zoom(bb)
cda<-get_map(bb,zoom=13,maptype="roadmap", source='google')
ggmap(cda) +  geom_point(aes(x=zz$Longitude, y=zz$Latitude, color=zz$L1), alpha=.25, data=zz) + guides( guide = "none" ) + scale_color_manual(values = c("black","dodgerblue"),  labels = c("Accident","Standard"), name = "Occurrences")  + scale_alpha_manual(c(1.5,.7,.15)) + ggtitle("Accidents Predicted at 6PM .90 threshold")
dev.off()

png("../Graphs & Images/R Maps/April03/April03_6AM_TimeSorted.png", width=6,height=6,units='in', res=800)
lats<-c(34.99, 35.45)
lons<-c(-85.4,-85.05)
par(mar = rep(0, 4))
bb<-make_bbox(lon=lons,lat=lats, f=0.05)
calc_zoom(bb)
cda<-get_map(bb,zoom=13,maptype="roadmap", source='google')
ggmap(cda) +  geom_point(aes(x=zz$Longitude, y=zz$Latitude, color=zz$L1), data=zz) + guides( guide = "none" ) + scale_color_manual(values = c("black","red"),  labels = c("Accident","TimeSorted"), name = "Occurrences")  + scale_alpha_manual(c(1.5,.7)) + ggtitle("Accidents Predicted at 6AM Time Sorted")
dev.off()
```


```{r}
##Find probabilities

forecastMMR =read.csv("../Excel & CSV Sheets/ETRIMS/Forecast-for4-3-2019_2019-04-03_12_minmax_withpred.csv", header=T)
a=which(forecastMMR$Prediction==1)
length(a)
sevenfive = which(forecastMMR$Probability>=0.75)
length(sevenfive)
ninety = which(forecastMMR$Probability>=0.90)
length(ninety)
sixAM = which(forecastMMR$Probability>=0.95)
length(ninefive)

forecaststand =read.csv("../Excel & CSV Sheets/ETRIMS/Forecast-for4-3-2019_2019-04-03_12_noMM.csv", header=T)
a=which(forecaststand$Prediction==1)
length(a)
sevenfive = which(forecaststand$Probability>=0.75)
length(sevenfive)
ninety = which(forecaststand$Probability>=0.90)
length(ninety)
sixAM = which(forecaststand$Probability>=0.95)
length(ninefive)
```

```{r}
library(ggmap)
forecast = read.csv("/Users/pete/Downloads/Forecast-for5-14-2019_2019-05-14_9.csv", header=T)
forecast = forecast[which(forecast$Prediction==1),]
hours = unique(forecast$Hour)

# min(forecast$Latitude)
# max(forecast$Latitude)
# mean(forecast$Latitude)
# mean(forecast$Longitude)
# min(forecast$Longitude)
# max(forecast$Longitude)
register_google(key="AIzaSyB9SbDxFzEubEN3icbAce4T2U262jskSlg")

thishour = forecast[which(forecast$Hour==0),]
# png("/Users/pete/Documents/GitHub/SCAL_USIgnite-911/Graphs & Images/ResultsFromGridIterations/PredictionMapForMay14_9am_0", width=8,height=8,units='in', res=300)
highprob = thishour[which(thishour$Probability>=.90),]
midprob = thishour[which(thishour$Probability>=.75),]
lowprob = thishour[which(thishour$Probability>=.5),]
ggmap(get_googlemap(center = c(lon = -85.225, lat = 35.07),
                  zoom = 11, scale = 2,
                  maptype ='roadmap',
                  color = 'bw')) +   
# geom_point(aes(x = Longitude, y = Latitude), colour = "yellow", data = lowprob, alpha=0.9, size = 2) +
geom_point(aes(x = Longitude, y = Latitude), colour = "orange", data = midprob, alpha=0.9, size = 2) +  
geom_point(aes(x = Longitude, y = Latitude), colour = "red", data = highprob, alpha=0.9, size = 2) 

# dev.off()
```

```{r}
# forecast = read.csv("/Users/pete/Downloads/Forecast-for5-14-2019_2019-05-14_9.csv", header=T)
# forecast = forecast[which(forecast$Prediction==1),]
# # hours = unique(forecast$Hour)
# polys = read.csv("/Users/pete/Documents/GitHub/SCAL_USIgnite-911/Excel & CSV Sheets/Grid Layout Test Files/VerticesPoints.csv")
# head(polys)

accidents = read.csv("../Excel & CSV Sheets/2019 Data/Final Form Reports/911_Reports_for_2019-05-14_FinalForm.csv", header = TRUE)
forecast = read.csv("../Excel & CSV Sheets/Grid Layout Test Files/Forecast_for_5-14-2019_on_5-14-2019_9_grid.csv", header=TRUE)
forecast = forecast[which(forecast$Prediction==1),]

thishour = forecast[which(forecast$Hour>=0 & forecast$Hour<=4),]
accidents = accidents[which(accidents$Hour>=0 & accidents$Hour <=4),]

low = which(thishour$Probability>=0.5)
low=thishour[low,]
mid = which(thishour$Probability>=0.75)
mid=thishour[mid,]
high = which(thishour$Probability>=0.95)
high=thishour[high,]
# png("/Users/pete/Documents/GitHub/SCAL_USIgnite-911/Graphs & Images/ResultsFromGridIterations/HeatMapMapForMay13", width=8,height=8,units='in', res=300)
par(mar = rep(0, 4))
lons = c(-85.39, -85.05)
lats = c(34.99, 35.15)
bb<-make_bbox(lon=lons,lat=lats, f=0.05)
calc_zoom(bb)
cda<-get_map(bb,zoom=11,maptype="watercolor", source='stamen')
ggmap(cda, legend = "bottom") +
  xlim(lons)+ylim(lats)+theme_minimal(base_size = 22)+
  labs(x="",y="", title="Accidents in Chattanooga") +
 geom_tile(aes(x = Longitude, y = Latitude), data = low, alpha= low$Probability, color='yellow',fill='yellow', size = 1) +  
  geom_tile(aes(x = Longitude, y = Latitude), data = mid, alpha= mid$Probability, color='orange', fill='orange', size = 1) + 
  geom_tile(aes(x = Longitude, y = Latitude), data = high, alpha= high$Probability, color='red', fill='red', size = 1) +  geom_point(aes(x=accidents$Longitude, y=accidents$Latitude), data=accidents, color= 'black', alpha=.7, size=2)
# dev.off()

# + scale_fill_gradientn(name = "Probability", space = "Lab", colours=)
```

```{r}
polys$Grid_Block = polys$ORIG_FID

dat <- merge(thishour, polys, by = "Grid_Block", all.x = TRUE)
colnames(dat)

library(rio)
write.csv(dat, file = "/Users/pete/Documents/GitHub/SCAL_USIgnite-911/Excel & CSV Sheets/Grid Layout Test Files/Combined.csv")
```

```{r}
dataset = read.csv("/Users/pete/Documents/GitHub/SCAL_USIgnite-911/Excel & CSV Sheets/Full Data with Year.csv",sep=",")
dataset = dataset[which(dataset$Accident==1),]
tabMon = table(dataset$Year, dataset$Month)

barplot(tabMon, ylab="Frequency", xlab="Month", main="Side-By-Side Bar Chart", col=c("blue", "green", "red" ), beside=TRUE, width=.3)
legend("topleft", title="Year", legend= c(2017,2018,2019), fill =c("blue", "green", "red" ), box.lty=0)

tab = table(dataset$Year)
barplot(tab)

tabMon = table(dataset$Year, dataset$Month)
```

```{r}
polys[0:5]
png("/Users/pete/Documents/GitHub/SCAL_USIgnite-911/Graphs & Images/ResultsFromGridIterations/PolygonMap", width=8,height=8,units='in', res=300)
ggmap(get_googlemap(center = c(lon = -85.225, lat = 35.07),
                  zoom = 11, scale = 2,
                  maptype ='roadmap',
                  color = 'bw'), layout='tight') +
geom_polygon(data = fortify(polys),
                  aes(X, Y, group = ORIG_FID),
                  fill = NA, colour = "red", alpha = 0.2)
dev.off()
```

